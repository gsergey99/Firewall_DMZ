# Do not edit. This file is provisioned by ansible.
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]


-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A INPUT -i eth0 -m tcp -p tcp --dport 22 -j ACCEPT
-A INPUT -j LOG -m limit --limit 5/min --log-prefix="[INPUT] "

# Configuración del DNS
-A INPUT -p udp --dport 53 -j ACCEPT
-A INPUT -p udp --sport 53 -j ACCEPT

# Configuración para DHCP
-A INPUT -p udp --sport 68 -j ACCEPT
-A INPUT -p udp --sport 67 -j ACCEPT

# Conexión y configuracion de Net-Data (dashboard)
-A INPUT -p tcp --dport 19999 -j ACCEPT

# Conexión al exterior para cada uno de las máquinas
-A INPUT -p tcp --dport 80 -m state --state NEW -j ACCEPT
-A INPUT -p tcp --dport 443 -j ACCEPT

# Permite mandar paquetes ICMP
-A INPUT -p icmp -j ACCEPT

-A INPUT -j DROP


-A FORWARD -j LOG --log-prefix="[FORWARD] "

-A FORWARD -p icmp -j ACCEPT

# Configuración para el servicio web

-A FORWARD -p tcp --dport 80 -j ACCEPT
-A FORWARD -p tcp --sport 80 -j ACCEPT

-A FORWARD -p tcp --dport 443 -j ACCEPT
-A FORWARD -p tcp --sport 443 -j ACCEPT

# Configuración para el servicio NTP

-A FORWARD -p udp --dport 123 -j ACCEPT

-A FORWARD -j DROP

-A OUTPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
-A OUTPUT -o eth0 -p tcp --sport 22 -j ACCEPT

# Configuración DNS para establecer updates en las máquinas

-A OUTPUT -p tcp --dport 53 -m state --state NEW -j ACCEPT
-A OUTPUT -p udp --dport 53 -m state --state NEW -j ACCEPT

# Configuración del DHCP

-A OUTPUT -p udp --sport 68 -j ACCEPT
-A OUTPUT -p udp --sport 67 -j ACCEPT

# Conexión y configuracion de Net-Data (dashboard)
-A OUTPUT -p tcp --dport 19999 -j ACCEPT


# Configuración para las máquinas que tengan salida a internet

-A OUTPUT -p tcp --dport 80 -m state --state NEW -j ACCEPT
-A OUTPUT -p tcp --dport 443 -j ACCEPT


# Configuración para icmp
-A OUTPUT -p icmp -j ACCEPT

-A OUTPUT -j LOG --log-prefix="[OUTPUT] "
-A OUTPUT -j DROP

# Configuracion del log de drop de paquetes de entrada y salida. Se guarda en /var/log/messages
-N LOGGING
-A INPUT -j LOGGING
-A OUTPUT -j LOGGING
-A LOGGING -m limit --limit 2/min -j LOG --log-prefix "IPTables-Dropped: " --log-level 4
-A LOGGING -j DROP

COMMIT
*raw
:PREROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
COMMIT
*nat
:PREROUTING ACCEPT [0_0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING -o eth1 -j MASQUERADE
-A PREROUTING -i eth1 -p tcp --dport 80 -j DNAT --to-destination 10.0.0.2:80
-A PREROUTING -i eth1 -p tcp --dport 19999 -j DNAT --to-destination 192.168.1.128:19999

COMMIT


